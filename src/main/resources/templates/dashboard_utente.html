<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<link rel="stylesheet" th:href="@{/css/dashboard_utente.css}">

<head th:replace="fragments/generic_fragments :: head('Dashboard - PawPal')">
</head>

<body>

    <div th:replace="fragments/generic_fragments :: navbar(dashboard)"></div>
    <div th:replace="fragments/dashboard_fragments :: dashboard-sidebar"></div>

    <main>

        <div id="modifica_dati" class="container-fluid flex-column" style="display: none;">

            <section>

                <h2>Modifica dati</h2>

                <div class="row">

                    <form th:action="@{/dash/profilo/modifica_dati}" method="post" style="display: contents;">

                        <div class="col-12">

                            <fieldset>
                                <legend>Informazioni Personali</legend>

                                <div>
                                    <label class="form-label" for="nome">Nome</label>
                                    <input class="form-control" id="nome" name="nome" type="text"
                                        th:value="${#strings.defaultString(user.nome,'')}" />
                                </div>

                                <div>
                                    <label class="form-label" for="cognome">Cognome</label>
                                    <input class="form-control" id="cognome" name="cognome" type="text"
                                        th:value="${#strings.defaultString(user.cognome,'')}" />
                                </div>

                                <div>
                                    <label class="form-label" for="telefono">Telefono</label>
                                    <input class="form-control" id="telefono" name="telefono" type="tel"
                                        th:value="${#strings.defaultString(user.telefono,'')}" maxlength="10" />
                                </div>

                                <div>
                                    <label class="form-label" for="codiceFiscale">Codice fiscale</label>
                                    <input class="form-control" id="codiceFiscale" name="codiceFiscale" type="text"
                                        th:value="${#strings.defaultString(user.codiceFiscale,'')}" maxlength="16" />
                                </div>
                            </fieldset>

                        </div>

                        <div class="col-12"
                            th:if="${#authentication.authorities.![authority].contains('ROLE_VETERINARIO')}">

                            <fieldset>
                                <legend>Informazioni professionali</legend>

                                <div>
                                    <label class="form-label" for="indirizzo">Indirizzo</label>
                                    <input class="form-control" id="indirizzo" name="indirizzo" type="text"
                                        th:value="${#strings.defaultString(user.indirizzoStudio,'')}" />
                                </div>

                                <div>
                                    <label class="form-label" for="specializzazione">Specializzazione</label>
                                    <input class="form-control" id="specializzazione" name="specializzazione"
                                        type="text" th:value="${#strings.defaultString(user.specializzazione,'')}" />
                                </div>

                                <!-- CERCARE LE SPECIE PER VETERINARIO -->
                                <div>
                                    <label class="form-label">Specie trattate:</label>
                                    <div class="btn-group" role="group" aria-label="specie trattate dal veterinario">
                                        <div id="lista_specie" th:each="specie : ${lista_specie}" style="display: contents;">
                                            <input
                                                type="checkbox"
                                                class="btn-check"
                                                name="specie"
                                                th:value="${specie.id}"
                                                th:checked="${#lists.contains(lista_specie_selezionate, specie)}"
                                                th:id="'specie_' + ${specie.id}"
                                            />
                                            <label class="btn btn-outline-primary" th:for="'specie_' + ${specie.id}">
                                                <span th:text="${specie.nomeSpecie}">Nome Specie</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <!-- CERCARE LE PRESTAZIONI PER VETERINARIO -->
                                <div>
                                    <label class="form-label">Prestazioni offerte:</label>
                                    <div class="btn-group" role="group" aria-label="prestazioni offerte dal veterinario">
                                        <div id="lista_prestazioni" th:each="prestazione : ${lista_prestazioni}" style="display: contents;">
                                            <input
                                                type="checkbox"
                                                class="btn-check"
                                                name="prestazioni"
                                                th:value="${prestazione.id}"
                                                th:checked="${#lists.contains(lista_prestazioni_selezionate, prestazione)}"
                                                th:id="'prestazione_' + ${prestazione.id}" />
                                            <label class="btn btn-outline-primary" th:for="'prestazione_' + ${prestazione.id}">
                                                <span th:text="${prestazione.descrizione}">Nome Prestazione</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <div>
                                    <label class="form-label" for="iscrizione_albo">Numero di iscrizione
                                        all&#39;albo:</label>
                                    <input class="form-control" type="text" id="iscrizione_albo" name="iscrizioneAlbo"
                                        th:value="${#strings.defaultString(user.iscrizioneAlbo,'')}" maxlength="10">
                                </div>

                                <div>
                                    <label class="form-label"
                                        for="disponibilita_veterinario">Disponibilit&#224;:</label>
                                    <input class="form-control" type="text" id="disponibilita_veterinario"
                                        name="disponibilita"
                                        th:value="${#strings.defaultString(user.disponibilita,'')}">
                                </div>

                                <div>
                                    <label class="form-label" for="descrizione">Descrizione </label>
                                    <textarea class="form-control" id="descrizione" name="descrizione"
                                        th:text="${#strings.defaultString(user.descrizione,'')}"
                                        placeholder="Descrivi chi sei e di cosa ti occupi" maxlength="140"></textarea>
                                </div>

                            </fieldset>

                        </div>

                        <div class="form-actions">
                            <button class="btn btn-secondary" type="submit">Salva modifiche</button>
                            <button class="btn btn-secondary" type="reset">Annulla</button>
                        </div>

                    </form>

                </div>

            </section>

        </div>

        <div id="appuntamenti" class="container-fluid flex-column" style="display: none;">

            <section>

                <h2>I tuoi Appuntamenti</h2>

                <form th:action="@{/dash/appuntamenti}" method="get">
                    <input type="date" name="data" placeholder="Filtra per data">
                    <input type="text" name="veterinario" placeholder="Cerca per veterinario">
                    <button type="submit" class="btn btn-primary">Filtra</button>
                </form>

                <table class="table-appuntamenti">
                    <thead>
                        <tr>
                            <th th:text="${#authentication.authorities.![authority].contains('ROLE_VETERINARIO')} ? 'Cliente' : 'Veterinario'"></th>
                            <th th:if="${#authentication.authorities.![authority].contains('ROLE_CLIENTE')}">
                                Indirizzo
                            </th>
                            <th>Telefono</th>
                            <th>Data e Ora</th>
                            <th>Note</th>
                        </tr>
                    </thead>

                    <tbody>
                        <tr th:each="appuntamento : ${lista_appuntamenti}">
                            <td th:text="${appuntamento.nomeUtente + ' ' + appuntamento.cognomeUtente}"></td>
                            <td 
                                th:if="${#authentication.authorities.![authority].contains('ROLE_CLIENTE')}"
                                th:text="${appuntamento.indirizzoUtente}"
                            ></td>
                            <td th:text="${appuntamento.telefonoUtente}"></td>
                            <td th:text="${appuntamento.dataOraAppuntamento}"></td>
                            <td th:text="${appuntamento.noteAppuntamento}"></td>

                            <td>
                                <div>
                                    <form th:action="@{/dash/appuntamenti/modifica_appuntamento}" method="post">
                                        <!-- <input type="hidden" name="id" th:value="${appuntamento.id}" /> -->
                                        <button type="submit" class="btn btn-primary">Modifica</button>
                                    </form>

                                    <form th:action="@{/dash/appuntamenti/elimina_appuntamento}" method="post">
                                        <!-- <input type="hidden" name="id" th:value="${appuntamento.id}" /> -->
                                        <button type="submit" class="btn btn-danger">Elimina</button>
                                    </form>
                                </div>
                            </td>
                        </tr>

                    </tbody>

                </table>

                <div th:if="${#lists.isEmpty(lista_appuntamenti)}" class="no-data">
                    <p>Nessun appuntamento trovato.</p>
                </div>

            </section>

        </div>

            <!-- Prenotazione (solo cliente) -->
            <!-- <div th:if="${#authentication.authorities.![authority].contains('ROLE_CLIENTE')}" class="nuovo-appuntamento">
                <h3>Prenota un nuovo appuntamento</h3>
                <form th:action="@{/lista_veterinari/inserisci_appuntamento}" method="post">
                    <label for="veterinario">Veterinario</label>
                    <select name="veterinario" id="veterinario" required>
                        <option value="">Seleziona...</option>
                        <option th:each="v : ${veterinariDisponibili}" th:value="${v.id}" th:text="${v.nome}"></option>
                    </select>

                    <label for="data">Data</label>
                    <input type="date" name="data" id="data" required>

                    <label for="ora">Ora</label>
                    <input type="time" name="ora" id="ora" required>

                    <label for="motivo">Motivo</label>
                    <textarea name="motivo" id="motivo" rows="3" placeholder="Descrivi il motivo..."
                        required></textarea>

                    <button type="submit" class="btn">Prenota</button>
                </form>
            </div> -->
        </section>

        <div id="recensioni" class="container-fluid flex-column" style="display: none;"></div>

        <section class="recensioni-section">
            <h2>Recensioni</h2>

            <!-- CLIENTE: cronologia delle recensioni scritte -->
            <div th:if="${#authentication.authorities.![authority].contains('ROLE_CLIENTE')}">
                <h3>Le tue recensioni</h3>

                <div th:if="${#lists.isEmpty(lista_recensioni)}">
                    <p>Nessuna recensione inviata.</p>
                </div>

                <ul th:if="${!#lists.isEmpty(lista_recensioni)}" class="recensioni-list">
                    <li th:each="rec : ${lista_recensioni}" class="recensione-item">
                        <div class="rec-header">
                            <strong class="rec-vet">
                                <span
                                    th:text="${rec.veterinario != null ? rec.veterinario.nome : 'Veterinario'}">Veterinario</span>
                            </strong>
                            <span class="rec-date"
                                th:text="${rec.data != null ? #dates.format(rec.data,'dd/MM/yyyy') : ''}">01/01/2025</span>
                            <span class="rec-rating" th:text="${rec.valutazione} + ' / 5'">5 / 5</span>
                        </div>

                        <p class="rec-text" th:text="${rec.testo}">Testo recensione...</p>

                        <div class="rec-meta">
                            <small th:if="${rec.appuntamento != null}"
                                th:text="'Appuntamento: ' + (${rec.appuntamento.data} != null ? #dates.format(rec.appuntamento.data,'dd/MM/yyyy') : '') + ' – ' + (${rec.appuntamento.ora} != null ? rec.appuntamento.ora : '')">Appuntamento</small>
                        </div>

                        <div class="rec-actions">
                            <a th:href="@{/dash/recensioni/modifica/{id}(id=${rec.id})}" class="btn">Modifica</a>

                            <form th:action="@{/dash/recensioni/elimina_recensione}" method="post"
                                style="display:inline">
                                <input type="hidden" name="_method" value="delete" />
                                <input type="hidden" name="id" th:value="${rec.id}" />
                                <button type="submit" class="btn btn-danger">Elimina</button>
                            </form>
                        </div>
                    </li>
                </ul>
            </div>

            <!-- VETERINARIO: cronologia delle recensioni ricevute + possibilità di rispondere -->
            <div th:if="${#authentication.authorities.![authority].contains('ROLE_VETERINARIO')}">
                <h3>Recensioni ricevute</h3>

                <div th:if="${#lists.isEmpty(lista_recensioni)}">
                    <p>Nessuna recensione ricevuta.</p>
                </div>

                <ul th:if="${!#lists.isEmpty(lista_recensioni)}" class="recensioni-list">
                    <li th:each="rec : ${lista_recensioni}" class="recensione-item">
                        <div class="rec-header">
                            <strong class="rec-from"
                                th:text="${rec.cliente != null ? rec.cliente.nome : 'Cliente'}">Nome Cliente</strong>
                            <span class="rec-date"
                                th:text="${rec.data != null ? #dates.format(rec.data,'dd/MM/yyyy') : ''}">01/01/2025</span>
                            <span class="rec-rating" th:text="${rec.valutazione} + ' / 5'">5 / 5</span>
                        </div>

                        <p class="rec-text" th:text="${rec.testo}">Testo recensione...</p>

                        <div class="rec-meta">
                            <small th:if="${rec.appuntamento != null}"
                                th:text="'Appuntamento: ' + (${rec.appuntamento.data} != null ? #dates.format(rec.appuntamento.data,'dd/MM/yyyy') : '') + ' – ' + (${rec.appuntamento.ora} != null ? rec.appuntamento.ora : '')">Appuntamento</small>
                        </div>

                        <!-- Se è già presente una risposta, mostrarla -->
                        <div class="rec-reply" th:if="${rec.risposta != null}">
                            <p><strong>Risposta:</strong> <span th:text="${rec.risposta}">Testo risposta</span></p>
                        </div>

                        <!-- Form per inviare/modificare la risposta (invia a controller che gestisce creazione/aggiornamento) -->
                        <!-- <form th:action="@{/dash/recensioni/rispondi}" method="post" class="reply-form">
                            <input type="hidden" name="recensioneId" th:value="${rec.id}" />
                            <label th:for="${'reply__' + ${rec.id}}">Rispondi</label>
                            <textarea th:id="${'reply__' + ${rec.id}}" th:name="testoRisposta" rows="3"
                                placeholder="Scrivi una risposta..." th:text="${rec.risposta}"></textarea>
                            <div class="rec-actions">
                                <button type="submit" class="btn">Invia risposta</button>
                                <button type="reset" class="btn-cancel">Annulla</button>
                            </div>
                        </form> -->
                    </li>
                </ul>
            </div>
        </section>

        <div id="linee_guida" class="container-fluid flex-column" style="display: none;">
            <section>
                <h1>Linee Guida per Veterinari</h1>

                <p>Qui puoi consultare le linee guida ufficiali per la gestione dei pazienti e le best practices da
                    seguire.</p>

                <div>
                    <ul>
                        <li th:each="guida : ${lineeGuida}">
                            <h3 th:text="${guida.titolo}">Titolo linea guida</h3>
                            <p th:text="${guida.descrizione}">Descrizione della linea guida...</p>
                            <a th:href="@{${guida.link}}" target="_blank" class="btn">Leggi completo</a>
                        </li>
                    </ul>
                </div>

                <div th:if="${#lists.isEmpty(lineeGuida)}">
                    <p>Nessuna linea guida disponibile al momento.</p>
                </div>
            </section>
        </div>

    </main>

    <div th:replace="fragments/dashboard_fragments :: modifica_conto(email, 'false')"></div>
    <div th:replace="fragments/dashboard_fragments :: modifica_conto(username, 'false')"></div>
    <div th:replace="fragments/dashboard_fragments :: modifica_conto(password, 'true')"></div>

    <script th:inline="javascript">
        const modalId = /*[[${openModal}]]*/ null;

        if (modalId) {
            if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                const modalElement = document.getElementById(modalId);

                if (modalElement) {
                    const modalInstance = new bootstrap.Modal(modalElement);
                    modalInstance.show();
                }
            }
        }
    </script>

    <script th:src="@{/js/dashboard.js}" defer></script>

    <style>
        body {
            margin-left: 200px;
        }
    </style>

</body>

</html>