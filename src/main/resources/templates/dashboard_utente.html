<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head th:replace="fragments :: head('Dashboard - PawPal')">
</head>

<body>

    <header th:replace="fragments :: dashboard-header('Dashboard Utente')"></header>

    <div class="sidebar">
        <div class="sidebar-header">
            <h3>Dashboard</h3>
        </div>

        <nav class="sidebar-nav">
            <ul>
                <li><a th:href="@{/dash/home}">Home</a></li>

                <li><a th:href="@{/dash/appuntamenti}">Appuntamenti</a></li>
                <li><a th:href="@{/dash/recensioni}">Recensioni</a></li>

                <li th:if="${#strings.equalsIgnoreCase(user.role,'VETERINARIO')}">
                    <a th:href="@{/dash/lineeguida}">Linee Guida</a>
                </li>

                <li class="submenu">
                    <a href="#">Profilo</a>
                    <ul>
                        <li><a th:href="@{/dash/profilo}">Modifica</a></li>
                        <li><a th:href="@{/dash/utenti/modifica_password}">Cambia Password</a></li>
                        <li><a th:href="@{/dash/utenti/elimina_account}">Elimina Account</a></li>
                        <li><a th:href="@{/logout}">Logout</a></li>
                    </ul>
                </li>
            </ul>
        </nav>
    </div>

    <main class="main-content">

        <section class="dashboard-section">
            <h2>I tuoi Appuntamenti</h2>


            <form class="filter-form" th:action="@{/dash/appuntamenti}" method="get">
                <input type="date" name="data" placeholder="Filtra per data">
                <input type="text" name="veterinario" placeholder="Cerca per veterinario">
                <button type="submit" class="btn">Filtra</button>
            </form>


            <table class="table-appuntamenti">
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Ora</th>
                        <th th:text="${#strings.equalsIgnoreCase(user.role,'veterinario')} ? 'Cliente' : 'Veterinario'">
                        </th>
                        <th>Specie</th>
                        <th>Motivo</th>
                        <th>Stato</th>
                        <th>Azioni</th>
                    </tr>
                </thead>

                <tbody>
                    <tr th:each="app : ${appuntamenti}">
                        <td th:text="${app.data}"></td>
                        <td th:text="${app.ora}"></td>
                        <td
                            th:text="${#strings.equalsIgnoreCase(user.role,'veterinario')} ? ${app.cliente.nome} : ${app.veterinario.nome}">
                        </td>
                        <td th:text="${app.specie}"></td>
                        <td th:text="${app.motivo}"></td>
                        <td th:text="${app.stato}"></td>

                        <td>

                            <div th:if="${#strings.equalsIgnoreCase(user.role,'veterinario')}">
                                <form th:action="@{/dash/appuntamenti/modifica_appuntamento}" method="post">
                                    <input type="hidden" name="_method" value="put" />
                                    <input type="hidden" name="id" th:value="${app.id}" />
                                    <button type="submit" class="btn btn-primary">Modifica</button>
                                </form>

                                <form th:action="@{/dash/appuntamenti/elimina_appuntamento}" method="post">
                                    <input type="hidden" name="_method" value="delete" />
                                    <input type="hidden" name="id" th:value="${app.id}" />
                                    <button type="submit" class="btn btn-danger">Elimina</button>
                                </form>
                            </div>


                            <div th:if="${#strings.equalsIgnoreCase(user.role,'cliente')}">
                                <form th:action="@{/dash/appuntamenti/elimina_appuntamento}" method="post">
                                    <input type="hidden" name="_method" value="delete" />
                                    <input type="hidden" name="id" th:value="${app.id}" />
                                    <button type="submit" class="btn btn-warning">Annulla</button>
                                </form>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>

            <div th:if="${#lists.isEmpty(appuntamenti)}" class="no-data">
                <p>Nessun appuntamento trovato.</p>
            </div>

            <!-- Prenotazione (solo cliente) -->
            <div th:if="${#strings.equalsIgnoreCase(user.role,'cliente')}" class="nuovo-appuntamento">
                <h3>Prenota un nuovo appuntamento</h3>
                <form th:action="@{/lista_veterinari/inserisci_appuntamento}" method="post">
                    <label for="veterinario">Veterinario</label>
                    <select name="veterinario" id="veterinario" required>
                        <option value="">Seleziona...</option>
                        <option th:each="v : ${veterinariDisponibili}" th:value="${v.id}" th:text="${v.nome}"></option>
                    </select>

                    <label for="data">Data</label>
                    <input type="date" name="data" id="data" required>

                    <label for="ora">Ora</label>
                    <input type="time" name="ora" id="ora" required>

                    <label for="motivo">Motivo</label>
                    <textarea name="motivo" id="motivo" rows="3" placeholder="Descrivi il motivo..."
                        required></textarea>

                    <button type="submit" class="btn">Prenota</button>
                </form>
            </div>
        </section>

        <section class="recensioni-section">
            <h2>Recensioni</h2>

            <!-- CLIENTE: cronologia delle recensioni scritte -->
            <div th:if="${#strings.equalsIgnoreCase(user.role,'CLIENTE')}">
                <h3>Le tue recensioni</h3>

                <div th:if="${#lists.isEmpty(recensioniScritte)}">
                    <p>Nessuna recensione inviata.</p>
                </div>

                <ul th:if="${!#lists.isEmpty(recensioniScritte)}" class="recensioni-list">
                    <li th:each="rec : ${recensioniScritte}" class="recensione-item">
                        <div class="rec-header">
                            <strong class="rec-vet">
                                <span
                                    th:text="${rec.veterinario != null ? rec.veterinario.nome : 'Veterinario'}">Veterinario</span>
                            </strong>
                            <span class="rec-date"
                                th:text="${rec.data != null ? #dates.format(rec.data,'dd/MM/yyyy') : ''}">01/01/2025</span>
                            <span class="rec-rating" th:text="${rec.valutazione} + ' / 5'">5 / 5</span>
                        </div>

                        <p class="rec-text" th:text="${rec.testo}">Testo recensione...</p>

                        <div class="rec-meta">
                            <small th:if="${rec.appuntamento != null}"
                                th:text="'Appuntamento: ' + (${rec.appuntamento.data} != null ? #dates.format(rec.appuntamento.data,'dd/MM/yyyy') : '') + ' – ' + (${rec.appuntamento.ora} != null ? rec.appuntamento.ora : '')">Appuntamento</small>
                        </div>

                        <div class="rec-actions">
                            <a th:href="@{/dash/recensioni/modifica/{id}(id=${rec.id})}" class="btn">Modifica</a>

                            <form th:action="@{/dash/recensioni/elimina}" method="post" style="display:inline">
                                <input type="hidden" name="_method" value="delete" />
                                <input type="hidden" name="id" th:value="${rec.id}" />
                                <button type="submit" class="btn btn-danger">Elimina</button>
                            </form>
                        </div>
                    </li>
                </ul>
            </div>

            <!-- VETERINARIO: cronologia delle recensioni ricevute + possibilità di rispondere -->
            <div th:if="${#strings.equalsIgnoreCase(user.role,'VETERINARIO')}">
                <h3>Recensioni ricevute</h3>

                <div th:if="${#lists.isEmpty(recensioniRicevute)}">
                    <p>Nessuna recensione ricevuta.</p>
                </div>

                <ul th:if="${!#lists.isEmpty(recensioniRicevute)}" class="recensioni-list">
                    <li th:each="rec : ${recensioniRicevute}" class="recensione-item">
                        <div class="rec-header">
                            <strong class="rec-from"
                                th:text="${rec.cliente != null ? rec.cliente.nome : 'Cliente'}">Nome Cliente</strong>
                            <span class="rec-date"
                                th:text="${rec.data != null ? #dates.format(rec.data,'dd/MM/yyyy') : ''}">01/01/2025</span>
                            <span class="rec-rating" th:text="${rec.valutazione} + ' / 5'">5 / 5</span>
                        </div>

                        <p class="rec-text" th:text="${rec.testo}">Testo recensione...</p>

                        <div class="rec-meta">
                            <small th:if="${rec.appuntamento != null}"
                                th:text="'Appuntamento: ' + (${rec.appuntamento.data} != null ? #dates.format(rec.appuntamento.data,'dd/MM/yyyy') : '') + ' – ' + (${rec.appuntamento.ora} != null ? rec.appuntamento.ora : '')">Appuntamento</small>
                        </div>

                        <!-- Se è già presente una risposta, mostrarla -->
                        <div class="rec-reply" th:if="${rec.risposta != null}">
                            <p><strong>Risposta:</strong> <span th:text="${rec.risposta}">Testo risposta</span></p>
                        </div>

                        <!-- Form per inviare/modificare la risposta (invia a controller che gestisce creazione/aggiornamento) -->
                        <form th:action="@{/dash/recensioni/rispondi}" method="post" class="reply-form">
                            <input type="hidden" name="recensioneId" th:value="${rec.id}" />
                            <label th:for="${'reply__' + ${rec.id}}">Rispondi</label>
                            <textarea th:id="${'reply__' + ${rec.id}}" th:name="testoRisposta" rows="3"
                                placeholder="Scrivi una risposta..." th:text="${rec.risposta}"></textarea>
                            <div class="rec-actions">
                                <button type="submit" class="btn">Invia risposta</button>
                                <button type="reset" class="btn-cancel">Annulla</button>
                            </div>
                        </form>
                    </li>
                </ul>
            </div>
        </section>

        <section class="modifica-profilo">
            <h1>Modifica profilo</h1>

            <form th:action="@{/dash/profilo/modifica_dati}" method="post" class="form-profilo">

                <fieldset>
                    <h3>Informazioni Personali</h3>

                    <label for="nome">Nome</label>
                    <input id="nome" name="nome" type="text" th:value="${#strings.defaultString(user.nome,'')}" />

                    <label for="cognome">Cognome</label>
                    <input id="cognome" name="cognome" type="text"
                        th:value="${#strings.defaultString(user.cognome,'')}" />

                    <label for="telefono">Telefono</label>
                    <input id="telefono" name="telefono" type="tel"
                        th:value="${#strings.defaultString(user.telefono,'')}" />

                    <label for="codiceFiscale">Codice fiscale</label>
                    <input id="codiceFiscale" name="codiceFiscale" type="text"
                        th:value="${#strings.defaultString(user.codiceFiscale,'')}" />
                </fieldset>


                <fieldset>
                    <legend>Informazioni Account</legend>

                    <label for="username">Username</label>
                    <input id="username" name="username" type="text"
                        th:value="${#strings.defaultString(user.username,'')}" />

                    <label for="email">Email</label>
                    <input id="email" name="email" type="email" th:value="${#strings.defaultString(user.email,'')}" />
                </fieldset>

                <section th:if="${#strings.equalsIgnoreCase(user.role,'VETERINARIO')}">
                    <fieldset>
                        <h3>Informazioni professionali</h3>

                        <label for="indirizzo">Indirizzo</label>
                        <input id="indirizzo" name="indirizzo" type="text"
                            th:value="${#strings.defaultString(user.indirizzo,'')}" />

                        <label for="specializzazione">Specializzazione</label>
                        <input id="specializzazione" name="specializzazione" type="text"
                            th:value="${#strings.defaultString(user.specializzazione,'')}" />
                        <label for="descrizione">Descrizione </label>

                        <textarea id="descrizione" name="descrizione"
                            th:text="${#strings.defaultString(user.descrizione,'')}"
                            placeholder="Descrivi chi sei e di cosa ti occupi"></textarea>

                        <div class="specie-section">
                            <h4>Specie</h4>
                            <ul>
                                <li th:each="spec, sStat : ${user.specie}">
                                    <input type="text" th:name="'specie[' + ${sStat.index} + ']'" th:value="${spec}" />
                                    <button type="button" class="remove-specie">Rimuovi</button>
                                </li>
                            </ul>
                            <div class="specie-add">
                                <input type="text" id="newSpecie" placeholder="Aggiungi specie">
                                <button type="button" class="add-specie">Aggiungi specie</button>
                            </div>
                        </div>

                        <div class="prestazioni-section">
                            <h4>Prestazioni</h4>

                            <div th:each="prest, pStat : ${user.prestazioni}" class="prestazione-item">
                                <input type="hidden" th:name="'prestazioni[' + ${pStat.index} + '].id'"
                                    th:value="${prest.id}" />
                                <label>Nome</label>
                                <input type="text" th:name="'prestazioni[' + ${pStat.index} + '].nome'"
                                    th:value="${#strings.defaultString(prest.nome,'')}" />
                                <label>Prezzo</label>
                                <input type="number" step="0.01" th:name="'prestazioni[' + ${pStat.index} + '].prezzo'"
                                    th:value="${#strings.defaultString(prest.prezzo,'')}" />
                                <label>Durata media (min)</label>
                                <input type="number" th:name="'prestazioni[' + ${pStat.index} + '].durata'"
                                    th:value="${#strings.defaultString(prest.durata,'')}" />
                                <label>Descrizione</label>
                                <textarea th:name="'prestazioni[' + ${pStat.index} + '].descrizione'"></textarea>
                                <button type="button" class="remove-prestazione">Rimuovi prestazione</button>
                            </div>


                            <div class="prestazione-add">
                                <p><strong>Aggiungi prestazione</strong></p>
                                <label>Nome</label>
                                <input type="text" id="nuova_prest_nome" name="nuovaPrestazione.nome"
                                    placeholder="Nome prestazione">
                                <label>Prezzo</label>
                                <input type="number" step="0.01" id="nuova_prest_prezzo" name="nuovaPrestazione.prezzo"
                                    placeholder="Prezzo">
                                <label>Durata media (min)</label>
                                <input type="number" id="nuova_prest_durata" name="nuovaPrestazione.durata"
                                    placeholder="Durata media">
                                <label>Descrizione</label>
                                <textarea id="nuova_prest_descrizione" name="nuovaPrestazione.descrizione"
                                    placeholder="Descrivi brevemente di cosa si tratta..."></textarea>
                                <button type="button" class="add-prestazione">Aggiungi prestazione</button>
                            </div>
                        </div>

                    </fieldset>
                </section>


                <div class="form-actions">
                    <button type="submit">Salva modifiche</button>
                    <a th:href="@{/dash/profilo}" class="btn-cancel">Annulla</a>
                </div>
            </form>
        </section>

        <section class="cambia-password" id="cambia-password">
            <h1>Cambia password</h1>

            <form th:action="@{/dash/utenti/modifica_password}" method="post" class="form-profilo">
                <fieldset>
                    <h3>Modifica password</h3>

                    <label for="currentPassword">Password attuale</label>
                    <input id="currentPassword" name="currentPassword" type="password" required
                        placeholder="Inserisci la password attuale" />

                    <label for="newPassword">Nuova password</label>
                    <input id="newPassword" name="newPassword" type="password" required minlength="8"
                        placeholder="Almeno 8 caratteri" />

                    <label for="confirmPassword">Conferma nuova password</label>
                    <input id="confirmPassword" name="confirmPassword" type="password" required minlength="8"
                        placeholder="Ripeti la nuova password" />

                    <p class="help-text">La nuova password deve essere almeno 8 caratteri. Assicurati che i campi
                        corrispondano.</p>
                </fieldset>

                <div class="form-actions">
                    <button type="submit">Aggiorna password</button>
                    <a th:href="@{/dash/profilo}" class="btn-cancel">Annulla</a>
                </div>
            </form>
        </section>

        <section class="elimina-account" id="elimina-account">
            <h1>Elimina account</h1>

            <form th:action="@{/dash/utenti/elimina_account}" method="post" class="form-profilo"
                onsubmit="return confirm('L\'eliminazione è irreversibile. Vuoi procedere?');">

                <input type="hidden" name="_method" value="delete" />

                <fieldset>
                    <h3>Conferma eliminazione</h3>

                    <p class="warning" style="color:var(--danger); font-weight:700;">
                        Attenzione: l'eliminazione dell'account è definitiva e cancellerà tutti i tuoi dati.
                    </p>

                    <label for="elimConfirmText">Per confermare, digita "ELIMINA" nel campo sottostante</label>
                    <input id="elimConfirmText" name="elimConfirmText" type="text" required
                        placeholder="Digita ELIMINA per confermare" />

                    <label for="elimPassword">Password attuale</label>
                    <input id="elimPassword" name="elimPassword" type="password" required
                        placeholder="Inserisci la password attuale" />

                    <p class="help-text">Per motivi di sicurezza è richiesta la password attuale.</p>
                </fieldset>

                <div class="form-actions">
                    <button type="submit" class="btn-danger">Elimina account</button>
                    <button type="reset" class="btn-cancel">Annulla</button>
                </div>
            </form>
        </section>

        <section class="logout-section" id="logout">
            <h1>Logout</h1>

            <form th:action="@{/logout}" method="post" class="form-profilo">
                <fieldset>
                    <h3>Esci dal tuo account</h3>
                    <p>Premi "Esci" per terminare la sessione corrente. Verrai reindirizzato alla pagina iniziale.</p>
                </fieldset>

                <div class="form-actions">
                    <button type="submit" class="btn">Esci</button>
                    <button type="reset" class="btn-cancel">Annulla</button>
                </div>
            </form>
        </section>
    </main>

</body>

</html>