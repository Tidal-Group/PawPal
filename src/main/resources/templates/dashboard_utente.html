<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<link rel="stylesheet" th:href="@{/css/dashboard_utente.css}">

<head th:replace="fragments/generic_fragments :: head('Dashboard - PawPal')"></head>

<body>

    <div th:replace="fragments/generic_fragments :: navbar(dashboard)"></div>
    <div th:replace="fragments/dashboard_fragments :: dashboard-sidebar"></div>

    <div th:replace="fragments/generic_fragments :: backend_message"></div>


    <main>

        <div id="modifica_dati" class="showable container-fluid flex-column" style="display: none;">

            <section>

                <h2>Modifica dati</h2>

                <div class="row">

                    <form th:action="@{/dash/profilo/modifica_dati}" method="post" style="display: contents;">

                        <div class="col-12">

                            <fieldset>
                                <legend>Informazioni Personali</legend>

                                <div>
                                    <label class="form-label" for="nome">Nome</label>
                                    <input class="form-control" id="nome" name="nome" type="text"
                                        th:value="${#strings.defaultString(user.nome,'')}" />
                                </div>

                                <div>
                                    <label class="form-label" for="cognome">Cognome</label>
                                    <input class="form-control" id="cognome" name="cognome" type="text"
                                        th:value="${#strings.defaultString(user.cognome,'')}" />
                                </div>

                                <div>
                                    <label class="form-label" for="telefono">Telefono</label>
                                    <input class="form-control" id="telefono" name="telefono" type="tel"
                                        th:value="${#strings.defaultString(user.telefono,'')}" maxlength="10" />
                                </div>

                                <div>
                                    <label class="form-label" for="codiceFiscale">Codice fiscale</label>
                                    <input class="form-control" id="codiceFiscale" name="codiceFiscale" type="text"
                                        th:value="${#strings.defaultString(user.codiceFiscale,'')}" maxlength="16" />
                                </div>
                            </fieldset>

                        </div>

                        <div class="col-12"
                            th:if="${#authentication.authorities.![authority].contains('ROLE_VETERINARIO')}">

                            <fieldset>
                                <legend>Informazioni professionali</legend>

                                <div>
                                    <label class="form-label" for="indirizzoStudio">Indirizzo</label>
                                    <input class="form-control" id="indirizzoStudio" name="indirizzoStudio" type="text"
                                        th:value="${#strings.defaultString(user.indirizzoStudio,'')}" />
                                </div>

                                <div>
                                    <label class="form-label" for="specializzazione">Specializzazione</label>
                                    <input class="form-control" id="specializzazione" name="specializzazione"
                                        type="text" th:value="${#strings.defaultString(user.specializzazione,'')}" />
                                </div>

                                <!-- CERCARE LE SPECIE PER VETERINARIO -->
                                <div>
                                    <label class="form-label">Specie trattate:</label>
                                    <div class="btn-group" role="group" aria-label="specie trattate dal veterinario">
                                        <div id="lista_specie" th:each="specie : ${lista_specie}" style="display: contents;">
                                            <input
                                                type="checkbox"
                                                class="btn-check"
                                                name="specie"
                                                th:value="${specie.id}"
                                                th:checked="${#lists.contains(lista_specie_selezionate, specie)}"
                                                th:id="'specie_' + ${specie.id}"
                                            />
                                            <label class="btn btn-outline-primary" th:for="'specie_' + ${specie.id}">
                                                <span th:text="${specie.nomeSpecie}">Nome Specie</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <!-- CERCARE LE PRESTAZIONI PER VETERINARIO -->
                                <div>
                                    <label class="form-label">Prestazioni offerte:</label>
                                    <div class="btn-group" role="group" aria-label="prestazioni offerte dal veterinario">
                                        <div id="lista_prestazioni" th:each="prestazione : ${lista_prestazioni}" style="display: contents;">
                                            <input
                                                type="checkbox"
                                                class="btn-check"
                                                name="prestazioni"
                                                th:value="${prestazione.id}"
                                                th:checked="${#lists.contains(lista_prestazioni_selezionate, prestazione)}"
                                                th:id="'prestazione_' + ${prestazione.id}" />
                                            <label class="btn btn-outline-primary" th:for="'prestazione_' + ${prestazione.id}">
                                                <span th:text="${prestazione.descrizione}">Nome Prestazione</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <div>
                                    <label class="form-label" for="iscrizione_albo">Numero di iscrizione
                                        all&#39;albo:</label>
                                    <input class="form-control" type="text" id="iscrizione_albo" name="iscrizioneAlbo"
                                        th:value="${#strings.defaultString(user.iscrizioneAlbo,'')}" maxlength="10">
                                </div>

                                <div>
                                    <label class="form-label"
                                        for="disponibilita_veterinario">Disponibilit&#224;:</label>
                                    <input class="form-control" type="text" id="disponibilita_veterinario"
                                        name="disponibilita"
                                        th:value="${#strings.defaultString(user.disponibilita,'')}">
                                </div>

                                <div>
                                    <label class="form-label" for="descrizione">Descrizione </label>
                                    <textarea class="form-control" id="descrizione" name="descrizione"
                                        th:text="${#strings.defaultString(user.descrizione,'')}"
                                        placeholder="Descrivi chi sei e di cosa ti occupi" maxlength="140"></textarea>
                                </div>

                            </fieldset>

                        </div>

                        <div class="form-actions">
                            <button class="btn btn-secondary" type="submit">Salva modifiche</button>
                            <button class="btn btn-secondary" type="reset">Annulla</button>
                        </div>

                    </form>

                </div>

            </section>

            <section>

                <h2>Elimina Account</h2>

                <div class="row">

                    <form th:action="@{/dash/profilo/elimina_account}" method="post" style="display: contents;">

                        <div class="col-12">

                            <fieldset>

                                <legend>Attenzione: operazione irreversibile!</legend>

                                <div>
                                    <label class="form-label"
                                        for="password_conferma_eliminazione_conto">Inserire password per confermare l'eliminazione:</label>
                                    <input 
                                        class="form-control"
                                        type="password"
                                        id="password_conferma_eliminazione_conto"
                                        name="password"
                                        required
                                    />
                                    <button class="btn btn-danger" type="submit">Elimina</button>
                                </div>

                            </fieldset>

                        </div>

                    </form>

                </div>

            </section>

        </div>

        <div id="appuntamenti" class="showable container-fluid flex-column" style="display: none;">

            <section>

                <h2>I tuoi Appuntamenti</h2>

                <form th:action="@{/dash/appuntamenti/filtra}" method="post">
                    <input
                        id="filtroData"
                        name="filtroData"
                        type="date"
                        placeholder="Filtra per data"
                        th:value="${filtroData != null ? filtroData : ''}"
                    >

                    <input
                        id="filtroNominativo"
                        name="filtroNominativo"
                        type="text"
                        th:value="${filtroNominativo}"
                        th:placeholder="${#authentication.authorities.![authority].contains('ROLE_CLIENTE') ? 'Cerca per veterinario' : 'Cerca per cliente'}"
                    >

                    <button type="submit" class="btn btn-primary">Filtra</button>

                </form>

                <table class="table-appuntamenti">
                    <thead>
                        <tr>
                            <th th:text="${#authentication.authorities.![authority].contains('ROLE_VETERINARIO')} ? 'Cliente' : 'Veterinario'"></th>
                            <th th:if="${#authentication.authorities.![authority].contains('ROLE_CLIENTE')}">
                                Indirizzo
                            </th>
                            <th>Telefono</th>
                            <th>Data e Ora</th>
                            <th>Note</th>
                            <th></th>
                        </tr>
                    </thead>

                    <tbody>
                        <tr th:each="appuntamento : ${lista_appuntamenti}">
                            <form
                                th:id="${'modificaAppuntamento' + appuntamento.idAppuntamento}"
                                th:action="@{/dash/appuntamenti/modifica_appuntamento}"
                                method="post"
                            >
                                <input type="hidden" th:value="${appuntamento.idAppuntamento}" name="id">

                                <td
                                    th:text="${(appuntamento.nomeUtente == null || appuntamento.cognomeUtente == null) ? 
                                             'Sconosciuto' : appuntamento.nomeUtente + ' ' + appuntamento.cognomeUtente}"
                                ></td>

                                <td 
                                    th:if="${#authentication.authorities.![authority].contains('ROLE_CLIENTE')}"
                                    th:text="${appuntamento.indirizzoUtente == null ? 'Sconosciuto' : appuntamento.indirizzoUtente}"
                                ></td>

                                <td 
                                    th:text="${appuntamento.telefonoUtente == null ? 'Sconosciuto' : appuntamento.telefonoUtente}"
                                ></td>

                                <!-- DEBUG: limitare input possibili per data e ora -->
                                <td>
                                    <input
                                        th:id="${'dataOraAppuntamento' + appuntamento.idAppuntamento}"
                                        name="dataOra"
                                        type="datetime-local"
                                        th:value="${appuntamento.dataOraAppuntamento}"
                                        readonly
                                    >
                                </td>

                                <td>
                                    <textarea
                                        th:id="${'noteAppuntamento' + appuntamento.idAppuntamento}"
                                        name="note"
                                        th:text="${appuntamento.noteAppuntamento}"
                                        readonly
                                    ></textarea>
                                </td>

                            </form>

                            <td>
                                <div>

                                    <button
                                        type="button"
                                        class="btn btn-primary"
                                        th:if="${#authentication.authorities.![authority].contains('ROLE_CLIENTE') and 
                                                appuntamento.dataOraAppuntamento > T(java.time.LocalDateTime).now()} and 
                                                appuntamento.idUtente != null"
                                        th:onclick="
                                            |document.getElementById('submitModifica${appuntamento.idAppuntamento}').style.display = 'block';
                                             this.style.display = 'none';
                                             document.getElementById('dataOraAppuntamento${appuntamento.idAppuntamento}').readOnly = false
                                             document.getElementById('noteAppuntamento${appuntamento.idAppuntamento}').readOnly = false|
                                        "
                                    >
                                        Modifica
                                    </button>

                                    <button
                                        th:if="${#authentication.authorities.![authority].contains('ROLE_CLIENTE') and 
                                                appuntamento.dataOraAppuntamento > T(java.time.LocalDateTime).now()}"
                                        th:id="${'submitModifica' + appuntamento.idAppuntamento}"
                                        type="submit"
                                        th:form="${'modificaAppuntamento' + appuntamento.idAppuntamento}"
                                        class="btn btn-primary"
                                        style="display: none;"
                                    >
                                        Conferma
                                    </button>

                                    <form 
                                        th:if="${appuntamento.dataOraAppuntamento > T(java.time.LocalDateTime).now()} and 
                                               appuntamento.idUtente != null"
                                        th:action="@{/dash/appuntamenti/elimina_appuntamento}"
                                        method="post"
                                    >
                                        <input type="hidden" th:value="${appuntamento.idAppuntamento}" name="idAppuntamento">
                                        <button type="submit" class="btn btn-danger">Elimina</button>
                                    </form>

                                </div>
                            </td>
                        </tr>

                    </tbody>

                </table>

                <div th:if="${#lists.isEmpty(lista_appuntamenti)}" class="no-data">
                    <p>Nessun appuntamento trovato.</p>
                </div>

            </section>

        </div>

        <div id="recensioni" class="showable container-fluid flex-column" style="display: none;">
            
            <section class="recensioni-section">

                <h2
                    th:text="${#authentication.authorities.![authority].contains('ROLE_CLIENTE')} ?
                             'Le tue recensioni' : 'Recensioni ricevute'"
                >
                    Recensioni
                </h2>

                <div th:if="${#lists.isEmpty(lista_recensioni)}">
                    <p 
                        th:text="${#authentication.authorities.![authority].contains('ROLE_CLIENTE')} ?
                                 'Nessuna recensione inviata' : 'Nessuna recensione ricevuta'"
                    >
                        Nessuna recensione.
                    </p>
                </div>

                <ul th:if="${!#lists.isEmpty(lista_recensioni)}" class="recensioni-list">
                    <li th:each="recensione : ${lista_recensioni}" class="recensione-item">
                        <div class="rec-header">
                            <strong class="rec-vet">
                                <span 
                                    th:text="${(#authentication.authorities.![authority].contains('ROLE_CLIENTE')) ? 
                                             ((recensione.nomeUtente == null || recensione.cognomeUtente == null) ? 'Sconosciuto' : (recensione.nomeUtente + ' ' + recensione.cognomeUtente)) : 
                                             (recensione.usernameUtente == null ? 'Sconosciuto' : recensione.usernameUtente)}"
                                ></span>
                            </strong>
                            <span
                                class="rec-date"
                                th:text="${#temporals.format(recensione.dataRecensione, 'dd/MM/yyyy')}"
                            ></span>
                            <span class="rec-rating" th:text="${recensione.votoRecensione} + ' / 5'"></span>
                        </div>

                        <p class="rec-text" th:text="${recensione.commentoRecensione}"></p>

                        <div class="rec-actions" th:if="${(#authentication.authorities.![authority].contains('ROLE_CLIENTE'))}">
                            <form 
                                th:action="@{/dash/recensioni/elimina_recensione}"
                                method="post"
                                style="display:inline"
                            >
                                <input type="hidden" name="id" th:value="${recensione.idRecensione}" />
                                <button type="submit" class="btn btn-danger">Elimina</button>
                            </form>
                        </div>
                    </li>
                </ul>

            </section>

        </div>

        <div id="linee_guida" class="showable container-fluid flex-column" style="display: none;">
            <section>
                <h1>Linee Guida per Veterinari</h1>

                <p>Qui puoi consultare le linee guida ufficiali per la gestione dei pazienti e le best practices da
                    seguire.</p>

                <div>
                    <ul>
                        <li th:each="guida : ${lineeGuida}">
                            <h3 th:text="${guida.titolo}">Titolo linea guida</h3>
                            <p th:text="${guida.descrizione}">Descrizione della linea guida...</p>
                            <a th:href="@{${guida.link}}" target="_blank" class="btn">Leggi completo</a>
                        </li>
                    </ul>
                </div>

                <div th:if="${#lists.isEmpty(lineeGuida)}">
                    <p>Nessuna linea guida disponibile al momento.</p>
                </div>
            </section>
        </div>

    </main>

    <div th:replace="fragments/dashboard_fragments :: modifica_conto(email, 'false')"></div>
    <div th:replace="fragments/dashboard_fragments :: modifica_conto(username, 'false')"></div>
    <div th:replace="fragments/dashboard_fragments :: modifica_conto(password, 'true')"></div>

    <script th:src="@{/js/dashboard.js}" defer></script>
    <div th:replace="fragments/generic_fragments :: show_views_scripts"></div>

</body>

</html>