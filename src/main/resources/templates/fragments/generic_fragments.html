<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head th:fragment="head(title)">

    <meta charset="UTF-8">
    <title th:text="${title}">PawPal</title>
    <link rel="stylesheet" th:href="@{/css/fragments.css}">

    <!-- BOOTSTRAP -->
    <link 
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
        rel="stylesheet"
        integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB"
        crossorigin="anonymous"
    >
    <script
        src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
        crossorigin="anonymous"
    ></script>
    <!-- BOOTSTRAP -->

    <script>
        const showEvent = new Event('show.element');
        const hiddenEvent = new Event('hidden.element');

        const renderCallbacks = {
            modalShowCallback: (element) => {
                if (element && typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                    const modalInstance = bootstrap.Modal.getOrCreateInstance(element);
                    modalInstance.show();
                }
            },
            modalHideCallback:  (element) => {
                if (element && typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                    const modalInstance = bootstrap.Modal.getInstance(element);
                    if (modalInstance && element.classList.contains('show'))
                        modalInstance.hide();
                }
            },
            viewShowCallback: (element) => {
                element.style.display = "flex";
            },
            viewHideCallback: (element) => {
                element.style.display = "none";
            }
        }

        document.addEventListener("DOMContentLoaded", () => {

            document.querySelectorAll("form[method='post']").forEach((form) => {
                form.addEventListener("submit", () => {
                    const redirectUrl = window.location.pathname + window.location.search + window.location.hash;

                    const redirectUrlHiddenInput = document.createElement("input");
                    redirectUrlHiddenInput.type = "hidden";
                    redirectUrlHiddenInput.name = "redirectUrl";
                    redirectUrlHiddenInput.value = redirectUrl;
                    form.appendChild(redirectUrlHiddenInput);
                });
            });

        });
    </script>

</head>

<!-- HEADER -->
<header th:fragment="navbar(active)">

    <nav class="navbar navbar-expand-lg bg-body-tertiary">

        <div class="container-fluid">

            <!-- LOGO -->
            <a class="navbar-brand d-flex align-items-center gap-2" th:href="@{/}">
                <img width="250x" height="250px" th:src="@{/img/logopawpal.svg}" alt="PawPal Logo" class="logo-img">
            </a>

            <!-- BOTTONE COLLAPSE -->
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarNavDropdown" aria-controls="navbarNavDropdown" aria-expanded="false"
                aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>


            <div class="collapse navbar-collapse" id="navbarNavDropdown">

                <!-- LINK A SINISTRA -->

                <ul class="navbar-nav">

                    <li class="nav-item">
                        <a class="nav-link" th:href="@{/}"
                            th:classappend="${active} == 'home' ? ' active' : ''">Home</a>
                    </li>

                    <li class="nav-item">
                        <a class="nav-link" th:href="@{/veterinari/lista_veterinari}"
                            th:classappend="${active} == 'lista_veterinari' ? ' active' : ''">Veterinari</a>
                    </li>

                    <li class="nav-item">
                        <a class="nav-link" th:href="@{/contatti}"
                            th:classappend="${active} == 'contatti' ? ' active' : ''">Contatti</a>
                    </li>

                </ul>

                <!-- LINK A DESTRA -->

                <ul class="navbar-nav ms-auto">

                    <!-- <ANONIMO> -->
                    <div sec:authorize="isAnonymous()" style="display: contents;">

                        <li class="nav-item">
                            <button class="btn btn-secondary" data-bs-target="#loginModal"
                                data-bs-toggle="modal">Login</button>
                        </li>

                        <li class="nav-item">
                            <button class="btn btn-secondary" data-bs-target="#registrazioneClienteModal" data-bs-toggle="modal">Registrati</button>
                        </li>

                    

                    </div>
                    <!-- </ANONIMO> -->

                    <!-- <CLIENTE-VETERINARIO> -->
                    <div sec:authorize="hasAnyRole('CLIENTE','VETERINARIO')" style="display: contents;">

                        <li class="nav-item dropdown">

                            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown"
                                aria-expanded="false">
                                <span th:text="${#authentication.name}">Utente</span>
                            </a>

                            <ul class="dropdown-menu">

                                <li>
                                    <p class="dropdown-item">
                                        <span
                                            th:if="${#authorization.expression('hasRole(''CLIENTE'')')}"><strong><em>Cliente</em></strong></span>
                                        <span
                                            th:if="${#authorization.expression('hasRole(''VETERINARIO'')')}"><strong><em>Veterinario</em></strong></span>
                                    </p>
                                </li>

                                <li>
                                    <hr class="dropdown-divider">
                                </li>

                                <li>
                                    <a class="dropdown-item" th:href="@{/dash#modifica_dati}">Profilo</a>
                                </li>

                                <li>
                                    <a class="dropdown-item" th:href="@{/dash#appuntamenti}">Appuntamenti</a>
                                </li>

                                <li>
                                    <a class="dropdown-item" th:href="@{/dash#recensioni}">Recensioni</a>
                                </li>

                                <li th:if="${#authorization.expression('hasRole(''VETERINARIO'')')}">
                                    <a class="dropdown-item" th:href="@{/dash#linee_guida}">Linee guida</a>
                                </li>

                                <li>
                                    <hr class="dropdown-divider">
                                </li>

                                <li>
                                    <form id="navbar_logout_form" th:action="@{/logout}" method="post"
                                        style="display: contents;">
                                        <a class="dropdown-item" href="#"
                                            onclick="document.getElementById('navbar_logout_form').submit()">Logout</a>
                                    </form>
                                </li>

                            </ul>

                        </li>

                        <li class="nav-item">
                            <a class="nav-link" th:href="@{/dash}" th:classappend="${active} == 'dashboard' ? ' active' : ''">Dashboard</a>
                        </li>

                    </div>
                    <!-- </CLIENTE-VETERINARIO> -->

                    <!-- <ADMIN> -->
                    <div sec:authorize="hasRole('ADMIN')" style="display: contents;">

                        <li class="nav-item dropdown">

                            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown"
                                aria-expanded="false">
                                <span th:text="${#authentication.name}">Admin</span>
                            </a>

                            <ul class="dropdown-menu">

                                <li>
                                    <p class="dropdown-item">
                                        <span><strong><em>Admin</em></strong></span>
                                    </p>
                                </li>

                                <li>
                                    <hr class="dropdown-divider">
                                </li>

                                <li>
                                    <a class="dropdown-item" th:href="@{/admin#utenti}">Utenti</a>
                                </li>

                                <li>
                                    <a class="dropdown-item" th:href="@{/admin#prestazioni}">Prestazioni</a>
                                </li>

                                <li>
                                    <a class="dropdown-item" th:href="@{/admin#specie}">Specie</a>
                                </li>

                                <li>
                                    <hr class="dropdown-divider">
                                </li>

                                <li>
                                    <form id="navbar_logout_form" th:action="@{/logout}" method="post"
                                        style="display: contents;">
                                        <a class="dropdown-item" href="#"
                                            onclick="document.getElementById('navbar_logout_form').submit()">Logout</a>
                                    </form>
                                </li>

                            </ul>

                        </li>

                        <li class="nav-item">
                            <a class="nav-link" th:href="@{/admin}">Dashboard</a>
                        </li>

                    </div>
                    <!-- </ADMIN> -->

                </ul>

            </div>

        </div>

    </nav>

</header>

<footer th:fragment="footer">

    <div class="footer text-center">
        <p>&copy; 2025 PawPal. Tutti i diritti riservati.</p>
    </div>

</footer>

<div th:fragment="backend_message">

    <div
        th:if="${successMessage != null and successMessage.length() > 0}"
        th:text="${successMessage}"
        class="alert alert-success auto-close-alert"
        role="alert"
    ></div>

    <div
        th:if="${errorMessage != null and errorMessage.length() > 0}"
        th:text="${errorMessage}"
        class="alert alert-danger auto-close-alert"
        role="alert"
    ></div>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const alerts = document.querySelectorAll('.auto-close-alert');
            alerts.forEach(alertElement => {
                if (alertElement) {
                    setTimeout(() => {
                        const bsAlert = bootstrap.Alert.getOrCreateInstance(alertElement);
                        bsAlert.close();
                    }, 3000);
                }
            });
        });
    </script>

</div>

<div th:fragment="show_views_scripts">

    <!-- SCRIPT TO CHANGE URL WHEN SHOWING/HIDING VIEWS (INCLUDING MODALS) -->
    <script th:inline="javascript">
        const isModal = (element) => element.classList.contains('modal');

        document.addEventListener("DOMContentLoaded", () => {

            function updateUrl(element, showEvent, hideEvent, showCallback, hideCallback) {
                const elementId = element.getAttribute('id');

                element.addEventListener(showEvent, function () {
                    const pathname = window.location.pathname;
                    const params = new URLSearchParams(window.location.search);
                    const hash = window.location.hash;

                    if(isModal(element)) params.set("modal", elementId);
                    else params.set("view", elementId);

                    const separator = params.toString() ? '?' : '';
                    history.pushState(null, '', `${pathname}${separator}${params}${hash}`);
                });

                element.addEventListener(hideEvent, function () {
                    const pathname = window.location.pathname;
                    const params = new URLSearchParams(window.location.search);   
                    const hash = window.location.hash;

                    if(isModal(element)) {
                        params.delete("modal");
                        // prevents the modal url from being saved in browser navigation history
                        const separator = params.toString() ? '?' : '';
                        history.replaceState(null, '', `${pathname}${separator}${params}${hash}`);
                    }
                    else {
                        params.delete("view");
                        history.pushState(null, '', `${pathname}${separator}${params}${hash}`);
                    }
                });

                window.addEventListener('popstate', function() {
                    const params = new URLSearchParams(window.location.search);
                    const stateKey = isModal(element) ? "modal" : "view";
                    if(params.get(stateKey) == elementId) showCallback(element);
                    else hideCallback(element);
                });
            };

            document.querySelectorAll('.modal').forEach((modalElement) => {
                updateUrl(
                    modalElement,
                    'show.bs.modal',
                    'hidden.bs.modal',
                    renderCallbacks.modalShowCallback,
                    renderCallbacks.modalHideCallback
                );
            });

            document.querySelectorAll('.showable').forEach((showableElement) => {
                updateUrl(
                    showableElement,
                    'show.element',
                    'hidden.element',
                    renderCallbacks.viewShowCallback,
                    renderCallbacks.viewHideCallback
                );
            });

            const params = new URLSearchParams(window.location.search);
            const viewId = params.get("view");
            const modalId = params.get("modal");
            if(viewId) {
                const view = document.getElementById(viewId);
                if(view) renderCallbacks.viewShowCallback(view);
            }
            if(modalId) {
                const modal = document.getElementById(modalId);
                if(modal) renderCallbacks.modalShowCallback(modal);
            }

        });

    </script>
    <!-- SCRIPT TO CHANGE URL WHEN SHOWING/HIDING VIEWS (INCLUDING MODALS) -->

</div>

</html>