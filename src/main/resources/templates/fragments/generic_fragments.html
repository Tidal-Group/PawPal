<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head th:fragment="head(title)">

    <meta charset="UTF-8">
    <title th:text="${title}">PawPal</title>
    <link rel="stylesheet" th:href="@{/css/fragments.css}">

    <!-- BOOTSTRAP -->
    <link 
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
        rel="stylesheet"
        integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB"
        crossorigin="anonymous"
    >
    <script
        src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
        crossorigin="anonymous"
    ></script>
    <!-- BOOTSTRAP -->

    <script>
        var showCallbacks = {};
        var showEvent = new Event('show.element');
        var hiddenEvent = new Event('hidden.element');

        var modalShowCallback = (modalElementId) => {
            const el = document.getElementById(modalElementId);
            if (el && typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                const modalInstance = bootstrap.Modal.getOrCreateInstance(el);
                modalInstance.show();
            }
        };;

        document.addEventListener("DOMContentLoaded", () => {
            document.querySelectorAll('form').forEach(form => {

                form.addEventListener('submit', () => {
                    const hashInput = document.createElement('input');
                    
                    hashInput.type = 'hidden';
                    hashInput.name = 'existing_hash';
                    hashInput.value = window.location.hash;

                    form.appendChild(hashInput);
                })

            });
        });
    </script>

</head>

<!-- HEADER -->
<header th:fragment="navbar(active)">

    <nav class="navbar navbar-expand-lg bg-body-tertiary">

        <div class="container-fluid">

            <!-- LOGO -->
            <a class="navbar-brand d-flex align-items-center gap-2" th:href="@{/}">
                <img width="250x" height="250px" th:src="@{/img/logopawpal.svg}" alt="PawPal Logo" class="logo-img">
            </a>

            <!-- BOTTONE COLLAPSE -->
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarNavDropdown" aria-controls="navbarNavDropdown" aria-expanded="false"
                aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>


            <div class="collapse navbar-collapse" id="navbarNavDropdown">

                <!-- LINK A SINISTRA -->

                <ul class="navbar-nav">

                    <li class="nav-item">
                        <a class="nav-link" th:href="@{/}"
                            th:classappend="${active} == 'home' ? ' active' : ''">Home</a>
                    </li>

                    <li class="nav-item">
                        <a class="nav-link" th:href="@{/veterinari/lista_veterinari}"
                            th:classappend="${active} == 'lista_veterinari' ? ' active' : ''">Veterinari</a>
                    </li>

                    <li class="nav-item">
                        <a class="nav-link" th:href="@{/contatti}"
                            th:classappend="${active} == 'contatti' ? ' active' : ''">Contatti</a>
                    </li>

                </ul>

                <!-- LINK A DESTRA -->

                <ul class="navbar-nav ms-auto">

                    <!-- <ANONIMO> -->
                    <div sec:authorize="isAnonymous()" style="display: contents;">

                        <li class="nav-item">
                            <button class="btn btn-secondary" data-bs-target="#loginModal"
                                data-bs-toggle="modal">Login</button>
                        </li>

                        <li class="nav-item">
                            <button class="btn btn-secondary" data-bs-target="#registrazioneClienteModal" data-bs-toggle="modal">Registrati</button>
                        </li>

                    

                    </div>
                    <!-- </ANONIMO> -->

                    <!-- <CLIENTE-VETERINARIO> -->
                    <div sec:authorize="hasAnyRole('CLIENTE','VETERINARIO')" style="display: contents;">

                        <li class="nav-item dropdown">

                            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown"
                                aria-expanded="false">
                                <span th:text="${#authentication.name}">Utente</span>
                            </a>

                            <ul class="dropdown-menu">

                                <li>
                                    <p class="dropdown-item">
                                        <span
                                            th:if="${#authorization.expression('hasRole(''CLIENTE'')')}"><strong><em>Cliente</em></strong></span>
                                        <span
                                            th:if="${#authorization.expression('hasRole(''VETERINARIO'')')}"><strong><em>Veterinario</em></strong></span>
                                    </p>
                                </li>

                                <li>
                                    <hr class="dropdown-divider">
                                </li>

                                <li>
                                    <a class="dropdown-item" th:href="@{/dash#modifica_dati}">Profilo</a>
                                </li>

                                <li>
                                    <a class="dropdown-item" th:href="@{/dash#appuntamenti}">Appuntamenti</a>
                                </li>

                                <li>
                                    <a class="dropdown-item" th:href="@{/dash#recensioni}">Recensioni</a>
                                </li>

                                <li th:if="${#authorization.expression('hasRole(''VETERINARIO'')')}">
                                    <a class="dropdown-item" th:href="@{/dash#linee_guida}">Linee guida</a>
                                </li>

                                <li>
                                    <hr class="dropdown-divider">
                                </li>

                                <li>
                                    <form id="navbar_logout_form" th:action="@{/logout}" method="post"
                                        style="display: contents;">
                                        <a class="dropdown-item" href="#"
                                            onclick="document.getElementById('navbar_logout_form').submit()">Logout</a>
                                    </form>
                                </li>

                            </ul>

                        </li>

                        <li class="nav-item">
                            <a class="nav-link" th:href="@{/dash}" th:classappend="${active} == 'dashboard' ? ' active' : ''">Dashboard</a>
                        </li>

                    </div>
                    <!-- </CLIENTE-VETERINARIO> -->

                    <!-- <ADMIN> -->
                    <div sec:authorize="hasRole('ADMIN')" style="display: contents;">

                        <li class="nav-item dropdown">

                            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown"
                                aria-expanded="false">
                                <span th:text="${#authentication.name}">Admin</span>
                            </a>

                            <ul class="dropdown-menu">

                                <li>
                                    <p class="dropdown-item">
                                        <span><strong><em>Admin</em></strong></span>
                                    </p>
                                </li>

                                <li>
                                    <hr class="dropdown-divider">
                                </li>

                                <li>
                                    <a class="dropdown-item" th:href="@{/admin#utenti}">Utenti</a>
                                </li>

                                <li>
                                    <a class="dropdown-item" th:href="@{/admin#prestazioni}">Prestazioni</a>
                                </li>

                                <li>
                                    <a class="dropdown-item" th:href="@{/admin#specie}">Specie</a>
                                </li>

                                <li>
                                    <hr class="dropdown-divider">
                                </li>

                                <li>
                                    <form id="navbar_logout_form" th:action="@{/logout}" method="post"
                                        style="display: contents;">
                                        <a class="dropdown-item" href="#"
                                            onclick="document.getElementById('navbar_logout_form').submit()">Logout</a>
                                    </form>
                                </li>

                            </ul>

                        </li>

                        <li class="nav-item">
                            <a class="nav-link" th:href="@{/admin}">Dashboard</a>
                        </li>

                    </div>
                    <!-- </ADMIN> -->

                </ul>

            </div>

        </div>

    </nav>

</header>

<footer th:fragment="footer">

    <div class="footer text-center">
        <p>&copy; 2025 PawPal. Tutti i diritti riservati.</p>
    </div>

</footer>

<div th:fragment="backend_message">

    <div
        th:if="${successMessage != null and successMessage.length() > 0}"
        th:text="${successMessage}"
        class="alert alert-success auto-close-alert"
        role="alert"
    ></div>

    <div
        th:if="${errorMessage != null and errorMessage.length() > 0}"
        th:text="${errorMessage}"
        class="alert alert-danger auto-close-alert"
        role="alert"
    ></div>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const alerts = document.querySelectorAll('.auto-close-alert');
            alerts.forEach(alertElement => {
                if (alertElement) {
                    setTimeout(() => {
                        const bsAlert = bootstrap.Alert.getOrCreateInstance(alertElement);
                        bsAlert.close();
                    }, 3000);
                }
            });
        });
    </script>

</div>

<div th:fragment="show_views_scripts">

    <!-- SCRIPT TO SHOW VIEWS (INCLUDING MODALS) ON REDIRECT -->
    <script th:inline="javascript">
        document.addEventListener("DOMContentLoaded", () => {
            const fullHash = window.location.hash;
            const elementIds = fullHash.substring(1).split('#');
            elementIds.forEach((elementId) => {
                if(elementId && showCallbacks[elementId])
                    showCallbacks[elementId](elementId);
            });
        });
    </script>
    <!-- SCRIPT TO SHOW VIEWS (INCLUDING MODALS) ON REDIRECT -->

    <!-- DEBUG: LEGGERE I COMMENTI DI GEMINI E AGGIUSTARE IL POPSTATE -->
    <!-- SCRIPT TO CHANGE URL WHEN SHOWING/HIDING VIEWS (INCLUDING MODALS) -->
    <script th:inline="javascript">

        // The current URL path/search part (without hash)
        let originalFullUrl = window.location.pathname + window.location.search;

        var updateUrl = (element, showEvent, hideEvent, hideCallback, raceConditionChecker) => {
            const elementId = element.getAttribute('id');
            const isModal = element.classList.contains('modal');

            // --- SHOW EVENT LISTENER (history.pushState) ---
            element.addEventListener(showEvent, function () {
                // Get the current hash IDs, filtering out empty strings
                const currentHashIDs = window.location.hash.substring(1).split('#').filter(id => id);
                
                let newHashIDs = [...currentHashIDs];
                
                if (isModal) {
                    // MODAL LOGIC: Replace the LAST hash ID if it was also a modal
                    const lastId = newHashIDs.length > 0 ? newHashIDs[newHashIDs.length - 1] : null;
                    const lastElement = lastId ? document.getElementById(lastId) : null;
                    
                    // Check if the last hash element is also a modal
                    if (lastElement && lastElement.classList.contains('modal')) {
                        // Substitutes the old modal ID with the new one
                        newHashIDs[newHashIDs.length - 1] = elementId; 
                    } else {
                        // Add the new modal ID to the end
                        newHashIDs.push(elementId);
                    }
                } else {
                    // SHOWABLE LOGIC: Always append (Stack behavior)
                    if (!newHashIDs.includes(elementId)) {
                        newHashIDs.push(elementId);
                    }
                }

                // Reconstruct the new hash string and push the state
                const newHash = newHashIDs.length > 0 ? "#" + newHashIDs.join('#') : "";
                history.pushState(null, '', originalFullUrl + newHash);
            });

            // --- HIDE EVENT LISTENER (history.replaceState) ---
            element.addEventListener(hideEvent, function () {
                // Get current hash IDs, filtering out the ID of the element being hidden
                let newHashIDs = window.location.hash.substring(1)
                                    .split('#')
                                    .filter(id => id && id !== elementId); 
                
                // Note: The raceConditionChecker logic is removed/simplified here 
                // as its original implementation might conflict with the new hash logic.
                // It's generally better to rely on `replaceState` and let the `popstate`
                // handler (which runs later) handle the final state.

                // If the element being hidden is NOT the last element in the hash,
                // we should only perform replaceState if it was in the current hash.
                // But since we filtered it out, we just need to update the URL.
                
                const newHash = newHashIDs.length > 0 ? "#" + newHashIDs.join('#') : "";

                // Use replaceState to clear the current history entry
                history.replaceState(null, '', originalFullUrl + newHash);
            });
            
            // --- POPSTATE LISTENER (Browser Back/Forward) ---
            if(hideCallback) {
                window.addEventListener('popstate', function() {
                    const currentHashIDs = window.location.hash.substring(1).split('#').filter(id => id);
                    
                    // If the element's ID is NO LONGER in the hash, hide it.
                    if (!currentHashIDs.includes(elementId)) {
                        // Check if the element is currently visible before calling hideCallback
                        // This prevents unnecessary hiding or double-hiding.
                        if (isModal && element.classList.contains('show')) {
                            hideCallback(element);
                        } else if (!isModal && element.style.display !== 'none') {
                            hideCallback(element);
                        }
                    }
                    // OPTIONAL: If the element's ID *IS* in the hash, ensure it is shown
                    else if (currentHashIDs.includes(elementId)) {
                        if (showCallbacks[elementId]) {
                            showCallbacks[elementId](elementId);
                        }
                    }
                });
            }
        };

        document.addEventListener("DOMContentLoaded", () => {
            // ... originalFullUrl defined globally above ...
            const elementIds = window.location.hash.substring(1).split('#');

            // --- MODALS SETUP ---
            document.querySelectorAll('.modal').forEach((modalElement) => {
                const modalId = modalElement.getAttribute('id');

                updateUrl(
                    modalElement,
                    'show.bs.modal',
                    'hidden.bs.modal',
                    originalFullUrl,
                    // hideCallback function: hides the modal
                    (modalElement) => {
                        const modalInstance = bootstrap.Modal.getInstance(modalElement);
                        if (modalInstance && modalElement.classList.contains('show'))
                            modalInstance.hide();
                    }
                    // raceConditionChecker is now obsolete with this logic
                );
            });

            // --- SHOWABLES SETUP ---
            document.querySelectorAll('.showable').forEach((showableElement) => {
                const showableId = showableElement.getAttribute('id');
                
                updateUrl(
                    showableElement,
                    'show.element',
                    'hidden.element',
                    originalFullUrl
                    // hideCallback function: hides the showable
                    // (showableElement) => {
                    //     showableElement.style.display = 'none';
                    // }
                );
            });

            // --- INITIAL LOAD ---
            elementIds.forEach((elementId) => {
                if(elementId && showCallbacks[elementId]) {
                    showCallbacks[elementId](elementId);
                }
            });

        });

    </script>
    <!-- SCRIPT TO CHANGE URL WHEN SHOWING/HIDING VIEWS (INCLUDING MODALS) -->

</div>

</html>