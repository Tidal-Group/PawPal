<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"  xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<link rel="stylesheet" th:href="@{/css/auth_fragments.css}">
<head th:replace="fragments/generic_fragments :: head('Veterinari - Pawpal')"></head>

<body>
    
    <div th:replace="fragments/generic_fragments :: navbar(veterinari)"></div>

    <main class="vet-layout-container">
        <div class="container-fluid">
            
            <div th:replace="fragments/generic_fragments :: backend_message"></div>

            <div class="row">

                <div class="col-lg-7">
                    <div class="vet-list-scroll-container">
                        <h1 class="mb-4">Lista Veterinari</h1>
                        
                        <div class="veterinari-list">
                            
                            <div th:if="${#lists.isEmpty(lista_veterinari)}" class="vet-card-empty">
                                <h4>Nessun veterinario trovato</h4>
                                <p>Prova a modificare i filtri di ricerca.</p>
                            </div>
                        
                            <div th:each="vet : ${lista_veterinari}" class="vet-card">
                                
                                <div class="vet-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" fill="currentColor" class="bi bi-building" viewBox="0 0 16 16">
                                        <path d="M4 2.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5zm3 0a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5zm3.5-.5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5zM4 5.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5zM7 5.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5zm3.5-.5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5zM4 8.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5zm3 0a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5zm3.5-.5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5z"/>
                                        <path d="M2 1a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1zm11 0H3v14h3v-2.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5V15h3z"/>
                                    </svg>
                                </div>
                        
                                <div class="vet-info">
                                    <h3 class="vet-nome" th:text="${vet.nome + ' ' + vet.cognome}"></h3>
                                    <p class="vet-specializzazione" th:text="${vet.specializzazione}"></p>
                                    <p class="vet-indirizzo" th:text="${vet.indirizzoStudio}"></p>
                                </div>
                        
                                <div class="vet-azione">
                                    <div>
                                        <button
                                            type="button"
                                            class="btn btn-outline-primary"
                                            th:data-veterinario="${vet.id}"
                                            data-bs-target="#cardVeterinarioModal"
                                            data-bs-toggle="modal">
                                            Visualizza
                                        </button>
                                    </div>

                                    <div>
                                        <button
                                            sec:authorize="hasRole('CLIENTE') or isAnonymous()"
                                            type="button"
                                            class="btn btn-outline-primary"
                                            th:data-veterinario="${vet.id}"
                                            data-bs-target="#appuntamentoVeterinarioModal"
                                            data-bs-toggle="modal">
                                            Prenota appuntamento
                                        </button>

                                        <button
                                            type="button"
                                            class="btn btn-outline-primary"
                                            th:data-veterinario="${vet.id}"
                                            data-bs-target="#recensioneVeterinarioModal"
                                            data-bs-toggle="modal">
                                            Lascia una recensione
                                        </button>
                                    </div>
                                </div>
                            </div>
                        
                        </div>
                        </div>
                </div>

                <div class="col-lg-5">
                    <div class="vet-search-sticky-container">
                        <section th:replace="fragments/veterinari_fragments :: ricerca_veterinari"></section>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <div th:replace="fragments/veterinari_fragments :: card_veterinario"></div>
    <div th:replace="fragments/veterinari_fragments :: modale_appuntamento_veterinario"></div>
    <div th:replace="fragments/veterinari_fragments :: modale_recensione_veterinario"></div>
    
    <section th:replace="fragments/auth_fragments :: login"></section>
    <section th:replace="fragments/auth_fragments :: registrazione_cliente"></section>
    <section th:replace="fragments/auth_fragments :: registrazione_veterinario"></section>

    <footer th:replace="fragments/generic_fragments :: footer"></footer>

    <script th:inline="javascript">
        function caricaProfiloVeterinario(idVeterinario) {
            return fetch(`/veterinari/lista_veterinari/${idVeterinario}`)
            .then(response => {
                if (!response.ok) throw new Error(`Impossibile caricare il profilo del veterinario. Stato: ${response.status}`);
                return response.json();
            })
            .then(data => {
                const vet = data.veterinario; 
                
                document.getElementById('registrazioneVeterinarioLabel').textContent = vet.nome + " " + vet.cognome;
                document.getElementById('specializzazione_veterinario').textContent = vet.specializzazione || 'N/D';
                document.getElementById('iscrizione_albo_veterinario').textContent = vet.iscrizioneAlbo || 'N/D';
                document.getElementById('descrizione_veterinario').textContent = vet.descrizione || 'Nessuna descrizione';
                document.getElementById('disponibilita_veterinario').textContent = vet.disponibilita || 'N/D';
                document.getElementById('indirizzo_studio_veterinario').textContent = vet.indirizzoStudio || 'N/D';
                document.getElementById('telefono_veterinario').textContent = vet.telefono || 'N/D';
                document.getElementById('email_veterinario').textContent = vet.email || 'N/D';
                
                document.getElementsByName('idVeterinario').forEach((input) => input.value = vet.id);
                
                const listaRecensioni = document.getElementById('recensioni-list');
                listaRecensioni.innerHTML = "";

                const listaSpecie = document.getElementById('specie_veterinario');
                listaSpecie.textContent = "";

                const listaPrestazioni = document.getElementById('prestazioni_veterinario');
                listaPrestazioni.textContent = "";

                const recensioni = data.recensioniDto;

                function formatRecensioneDate(dateString) {
                    const date = new Date(dateString);

                    const formatter = new Intl.DateTimeFormat('en-GB', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric'
                    });

                    return formatter.format(date);
                }

                function returnRecensioneStars(rating) {
                    let stars = "";
                    for(let i = 0; i < rating; i++) stars += "&#9733;";
                    for(let i = 0; i < 5 - rating; i++) stars += "&#9734;";
                    return stars;
                }

                if (recensioni && recensioni.length > 0) {
                    recensioni.forEach((recensione) => {
                        listaRecensioni.innerHTML += `
                            <li class="recensione-item">
                                <div class="cards-wrapper">
                                    <div class="card">
                                        <div class="card-body">
                                            <h5 class="card-title">

                                                <span>${recensione.usernameUtente}</span>
                                                -
                                                <span>${formatRecensioneDate(recensione.dataRecensione)}</span>

                                            </h5>

                                            <p class="card-text">“${recensione.commentoRecensione}”</p>

                                            <div>
                                                
                                                <span class="text-warning">${returnRecensioneStars(recensione.votoRecensione)}</span>

                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </li>
                        `;
                    });
                } else {
                    listaRecensioni.innerHTML = "<p>Nessuna recensione ancora.</p>";
                }

                const specie = data.specieDto;

                if (specie && specie.length > 0) {
                    specie.forEach((specie) => listaSpecie.textContent += specie.nomeSpecie + ", ");
                    listaSpecie.textContent = listaSpecie.textContent.substring(0, listaSpecie.textContent.length - 2);
                }

                const prestazioni = data.prestazioniDto;

                if(prestazioni && prestazioni.length > 0) {
                    prestazioni.forEach((prestazione) => listaPrestazioni.textContent += prestazione.descrizione + ", ");
                    listaPrestazioni.textContent = listaPrestazioni.textContent.substring(0, listaPrestazioni.textContent.length - 2);
                }
                
                return data;
            })
            .catch(error => {
                console.error("Errore nel fetch:", error);
                document.getElementById('registrazioneVeterinarioLabel').textContent = "Errore Caricamento";
                document.getElementById('recensioni-list').innerHTML = "<p>Impossibile caricare i dati. Riprova più tardi.</p>";
                return Promise.reject(error);
            });
        }
    
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof injectNavigationEvents !== 'function') {
                console.error("Errore: injectNavigationEvents non è definita. Assicurati che generic_fragments sia caricato.");
                return;
            }
    
            injectNavigationEvents(
                [
                    document.getElementById("cardVeterinarioModal"),
                    document.getElementById("appuntamentoVeterinarioModal"),
                    document.getElementById("recensioneVeterinarioModal")
                ],
                'show.bs.modal',
                'hidden.bs.modal',
                (event, element, elementId) => {
                    const params = new URLSearchParams(window.location.search);
                    let idVeterinario;
    
                    if(params.get("veterinario")) {
                        idVeterinario = params.get("veterinario");
                    } else if (event.relatedTarget) {
                        idVeterinario = event.relatedTarget.dataset.veterinario;
                    }
    
                    if(idVeterinario) {
                        caricaProfiloVeterinario(idVeterinario)
                        .then((data) => {
                            const pathname = window.location.pathname;
                            const params = new URLSearchParams(window.location.search);
                            const hash = window.location.hash;
                            params.set("veterinario", idVeterinario);
                            const separator = params.toString() ? '?' : '';
                            history.replaceState(null, '', `${pathname}${separator}${params}${hash}`);
                        })
                        .catch((error) => {
                            history.replaceState(null, '', window.location.pathname);
                        });
                    }
                },
                (event, element, elementId) => {
                    const pathname = window.location.pathname;
                    const params = new URLSearchParams(window.location.search);   
                    const hash = window.location.hash;
    
                    params.delete("veterinario");
                    const separator = params.toString() ? '?' : '';
                    history.replaceState(null, '', `${pathname}${separator}${params}${hash}`);
                },
                (event, element, elementId) => {
                    const params = new URLSearchParams(window.location.search);
                    if(params.get("modal") === elementId || params.get("veterinario")) {
                        // Assicurati che la modale esista prima di provare a mostrarla
                        const modalInstance = bootstrap.Modal.getOrCreateInstance(element);
                        if(modalInstance) modalInstance.show();
                    } else {
                        const modalInstance = bootstrap.Modal.getInstance(element);
                        if (modalInstance) {
                            modalInstance.hide();
                        }
                    }
                }
            );
        });
    
    </script>

    <div th:replace="fragments/generic_fragments :: show_views_scripts"></div>

</body>
</html>